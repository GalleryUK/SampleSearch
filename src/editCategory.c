#include "SampleSearch.h"#include "Globals.h"extern FSSpec theApplSpec;void editCategory (void)	/** update this for ghosts etc and merges ....**/{	Cell	myCellCoords;	FInfo	fndrInfo;	OSErr	iErr;	Str255 fdFldrMemberStr,fdFldrGroupStr;	unsigned long fdFldrMember;	unsigned long fdFldrGroup;	div_t	fdDiv;	short itemHit;				/** for dialog enquiry **/	DialogPtr	myDlg;			/** for dialog enquiry **/	Handle	iHndl;				/** for dialog enquiry **/	Rect	iRect;				/** for dialog enquiry **/	short	iType;				/** for dialog enquiry **/	short 	myRefNum;	short	iCnt,z;	short iRefNum;	Point myPoint;	long theFInfoCount;	FSSpec appSpec,docSpec;	Cell theCell;	short xitemHit;				/** for dialog enquiry **/	DialogPtr	xmyDlg;			/** for dialog enquiry **/	Handle	xiHndl;				/** for dialog enquiry **/	Rect	xiRect;				/** for dialog enquiry **/	short	xiType;				/** for dialog enquiry **/	Str255 theNewItem;	long inOutCount;	short tempshort;	short theindex;	MenuHandle theGroupMenu, theMemberMenu;	short groupRefNum,memberRefNum;	FSSpec theGroupSpec;	FSSpec theMemberSpec;	IOParam GMpb;	Str255 theReadText;		BlockMove (&theApplSpec,&theGroupSpec,70L);	BlockMove (&theApplSpec,&theMemberSpec,70L);		makeStr255("\pSampleSearchª Category Groups",theGroupSpec.name);	iErr = FSpOpenDF(&theGroupSpec,fsCurPerm,&groupRefNum);	if (iErr == -43)	{		iErr = FSpCreate(&theGroupSpec,'ttxt','TEXT',0);		if (iErr)		{			genError("\pCan't make categories file");			return;		}		iErr = FSpOpenDF(&theGroupSpec,fsCurPerm,&groupRefNum);		if (iErr)		{			genError("\pCan't open categories file");			return;		}		}		makeStr255("\pSampleSearchª Category Members",theMemberSpec.name);	iErr = FSpOpenDF(&theMemberSpec,fsCurPerm,&memberRefNum);	if (iErr == -43)	{		iErr = FSpCreate(&theMemberSpec,'ttxt','TEXT',0);		if (iErr)		{			genError("\pCan't make categories file");			return;		}		iErr = FSpOpenDF(&theMemberSpec,fsCurPerm,&memberRefNum);		if (iErr)		{			genError("\pCan't open categories file");			return;		}		}			theGroupMenu = GetMenu(20000);	theMemberMenu = GetMenu(20001);	AppendMenu(theGroupMenu,"\pNew Group");	AppendMenu(theMemberMenu,"\pNew Member");	SetItemStyle(theGroupMenu,1,2);	SetItemStyle(theMemberMenu,1,2);		SetItemStyle(theGroupMenu,2,2);	SetItemStyle(theMemberMenu,2,2);		GMpb.ioRefNum = groupRefNum;	GMpb.ioReqCount = 253;	GMpb.ioPosMode = 0x0D80 | fsAtMark;	GMpb.ioBuffer = (Ptr)theReadText;	iErr = 0;		while (!iErr)	{		iErr = PBRead((union ParamBlockRec *)&GMpb,false);		*(theReadText + GMpb.ioActCount) = 0;		CtoPstr ((Ptr)theReadText);		if (!iErr && GMpb.ioActCount > 0)			AppendMenu(theGroupMenu,theReadText);	}	iErr = FSClose(groupRefNum);			GMpb.ioRefNum = memberRefNum;	GMpb.ioReqCount = 253;	GMpb.ioPosMode = 0x0D80 | fsAtMark;	GMpb.ioBuffer = (Ptr)theReadText;	iErr = 0;	while (!iErr)	{		iErr = PBRead((union ParamBlockRec *)&GMpb,false);		*(theReadText + GMpb.ioActCount) = 0;		CtoPstr ((Ptr)theReadText);		if (!iErr && GMpb.ioActCount > 0)			AppendMenu(theMemberMenu,theReadText);	}	iErr = FSClose(memberRefNum);					if 	(!FInfolistInMem)	{						FInfoArrayPtr = totfindcounter;			//SetHandleSize(theFInfo,totfindcounter * sizeof(FInfo));			iErr = MemError();			if (iErr!=0)				genError("\pCould not expand FInfo");								checkHandleSize ((Handle)theFInfo,totfindcounter,sizeof(FInfo));											for (z=0;z<totfindcounter;z++)				{				iErr = FSpGetFInfo(&(*therealResults)[z],(*theFInfo)+z);			}				FInfolistInMem = true;	}		iErr = FSpGetFInfo(&(*therealResults)[(lCellCoords.v*DisplayedColumns)+lCellCoords.h*!DisplayComments],&fndrInfo);		//fdDiv = div (fndrInfo.fdFldr,256);		fdFldrGroup = (unsigned long)((fndrInfo.fdFldr>>8) & 0x00FF);	fdFldrMember = (unsigned long)(fndrInfo.fdFldr & 0x00FF);	NumToString(fdFldrGroup,fdFldrGroupStr);	NumToString(fdFldrMember,fdFldrMemberStr);	ParamText(fdFldrGroupStr,fdFldrMemberStr,0,0);		myDlg = GetNewDialog(6000,0L,(WindowPtr)-1);		SetPort (myDlg);	color.red = 56797;	color.green = 56797;	color.blue = 56797;	RGBBackColor(&color);	GetDItem(myDlg,3,&iType,&iHndl,&iRect);	SetDItem(myDlg,3,iType,(Handle)NewUserItemProc(MyItemProc),&iRect);		GetDItem ( myDlg, 6, &iType, &iHndl, &iRect );		/** put old values from file into dialog **/	SetCtlValue((ControlHandle)iHndl,(fdFldrGroup == 0) ? 0 : fdFldrGroup+2);	//SetIText ( iHndl, fdFldrGroupStr );	GetDItem ( myDlg, 7, &iType, &iHndl, &iRect );		/** put old values from file into dialog **/	SetCtlValue((ControlHandle)iHndl,(fdFldrMember == 0) ? 0 :fdFldrMember+2);		//SetIText ( iHndl, fdFldrMemberStr );	if (-((*therealResults)[(lCellCoords.v*DisplayedColumns)+lCellCoords.h*!DisplayComments].vRefNum)>maxVRef)	{		HideDItem(myDlg,4);		HideDItem(myDlg,5);	}		itemHit = 0;	ShowWindow(myDlg);	while (itemHit != 1 && itemHit != 2)	{		ModalDialog(xAlertFilter,&itemHit);			switch (itemHit)		{			case 1:				GetDItem ( myDlg, 6, &iType, &iHndl, &iRect ); /** read data from textedit **/				//GetIText ( iHndl, fdFldrGroupStr );					if (GetCtlValue((ControlHandle)iHndl) == 1)					fdFldrGroup = 0;				else					fdFldrGroup = GetCtlValue((ControlHandle)iHndl) - 2;																			GetDItem ( myDlg, 7, &iType, &iHndl, &iRect ); /** read data from textedit **/				//GetIText ( iHndl, fdFldrMemberStr );					if (GetCtlValue((ControlHandle)iHndl) == 1)					fdFldrMember = 0;				else					fdFldrMember = GetCtlValue((ControlHandle)iHndl) - 2;								//StringToNum(fdFldrGroupStr,&fdFldrGroup);				//StringToNum(fdFldrMemberStr,&fdFldrMember);				fndrInfo.fdFldr = ((fdFldrGroup & 0x000000FF) << 8) | (fdFldrMember & 0x000000FF);								watchcursor(true);				SetPt( &theCell, 0,0 );		/* start at top of list  */				while ( LGetSelect( TRUE, &theCell, myList) ) 				{					theindex = (theCell.v * DisplayedColumns) + (theCell.h * (DisplayedColumns != 1));					tempshort = fndrInfo.fdFldr;					iErr = FSpGetFInfo(&(*therealResults)[theindex],&fndrInfo);					fndrInfo.fdFldr = tempshort;					iErr = FSpSetFInfo(&(*therealResults)[theindex],&fndrInfo);					(*theFInfo)[theindex].fdFldr = fndrInfo.fdFldr;					LNextCell( TRUE, TRUE, &theCell, myList ); 	/* advance to next */				}				watchcursor(false);				reFound = true;					break;						case 6:				GetDItem(myDlg,6,&iType,&iHndl,&iRect);				if (GetCtlValue((ControlHandle)iHndl) == 2)				{					xmyDlg = GetNewDialog(21000,0L,(WindowPtr)-1);					SetPort (xmyDlg);					ModalDialog(0,&xitemHit);					if (xitemHit ==1)					{						GetDItem(xmyDlg,4,&xiType,&xiHndl,&xiRect);						GetIText(xiHndl,theNewItem);						AppendMenu(theGroupMenu,theNewItem);						xiType = CountMItems(theGroupMenu);					}					DisposDialog(xmyDlg);					SetPort (myDlg);						if (xitemHit == 1)					{						GetDItem(myDlg,6,&iType,&iHndl,&iRect);						/*xiType = CountMItems(theGroupMenu);						SetCtlValue((ControlHandle)iHndl,xiType);*/						iErr = FSpOpenDF(&theGroupSpec,fsCurPerm,&groupRefNum);						if (iErr)						{							genError("\pCan't open categories file");						}						iErr = SetFPos(groupRefNum,2,0L);						*(theNewItem + *theNewItem+1) = 0x0D;						*theNewItem += 1;						inOutCount = *theNewItem;						PtoCstr (theNewItem);						iErr = FSWrite(groupRefNum,&inOutCount,theNewItem);						FSClose (groupRefNum);					}				}			break;						case 7:				GetDItem(myDlg,7,&iType,&iHndl,&iRect);				if (GetCtlValue((ControlHandle)iHndl) == 2)				{					xmyDlg = GetNewDialog(21000,0L,(WindowPtr)-1);					SetPort (xmyDlg);					ModalDialog(0,&xitemHit);					if (xitemHit ==1)					{					GetDItem(xmyDlg,4,&xiType,&xiHndl,&xiRect);					GetIText(xiHndl,theNewItem);					AppendMenu(theMemberMenu,theNewItem);					xiType = CountMItems(theMemberMenu);					}					DisposDialog(xmyDlg);					SetPort (myDlg);							if (xitemHit == 1)					{						GetDItem(myDlg,7,&iType,&iHndl,&iRect);						//SetCtlValue((ControlHandle)iHndl,CountMItems(theMemberMenu));						iErr = FSpOpenDF(&theMemberSpec,fsCurPerm,&memberRefNum);						if (iErr)						{							genError("\pCan't open categories file");						}						iErr = SetFPos(memberRefNum,2,0L);						*(theNewItem + *theNewItem+1) = 0x0D;						*theNewItem += 1;						inOutCount = *theNewItem;						PtoCstr (theNewItem);						iErr = FSWrite(memberRefNum,&inOutCount,theNewItem);						FSClose (memberRefNum);					}				break;			}		}	}	DisposDialog (myDlg);}