#include "SampleSearch.h"#include "Globals.h"#include <Folders.h>void SaveAsFave(void);void AddToFaves(FSSpec	mySpec, short index);Boolean makefaveFile(short listIndex,FSSpec *theFaveFile, FSSpec *theFaveInfo);void AddToFaveTab(FSSpec	mySpec, short index,short whichList);void SaveAsTabFave(short whichList);OSErr copyVolsListToFVolsList(void);extern FSSpec	faveFSpec, faveISpec;void AddToFaves(FSSpec	mySpec, short index){	OSErr	iErr;	StandardFileReply	mySFReply;			short 	myRefNum;	long	myInOutCounter;	SFTypeList	myTypes;	long	totfindlen;	short z;	long theFInfoCount;	short iRefNum;	Handle hString[499],vRef[499];	long	theFSSpecLen, theFInfoLen;	FSSpec	checkForNull;	long	howFar;	extern FSSpec	faveFSpec, faveISpec;	SignedByte finalvRefNum = 0;	FSSpec	finalSpec;	short iCnt;	Boolean	matchedUp;	Str255 myTempStr;		if 	(!FInfolistInMem)	{		FInfoArrayPtr = totfindcounter;		//SetHandleSize(theFInfo,totfindcounter * sizeof(FInfo));		iErr = MemError();		if (iErr != 0)			genError("\pCan't resize theFInfo in save list");						checkHandleSize ((Handle)theFInfo,totfindcounter,sizeof(FInfo));					for (z=0;z<totfindcounter;z++)			{			iErr = FSpGetFInfo(&(*therealResults)[z],(*theFInfo)+z);		}			FInfolistInMem = true;	}	iRefNum = CurResFile();			myRefNum = FSpOpenResFile(&faveFSpec,fsCurPerm);	if (myRefNum == -1)	{			if ((iErr = ResError() )!= -39) 		{			genError("\pCould not open new resource fork");		}		else		{			FSpCreateResFile(&faveFSpec,'MgAl','SFfl',0);			iErr = ResError();			if (iErr!=0)				genError("\pCould not create resource file");			myRefNum = FSpOpenResFile(&faveFSpec,fsCurPerm);			if (myRefNum == -1)			{				genError ("\p Problem finding favourite res fork");				return;			}		}	}			UseResFile(myRefNum);		iErr = ResError();		if (iErr!=0)		genError("\pCould not use resource fork");	iCnt = Count1Resources('oVOL');	if (!iCnt)	/** no oVOLS yet **/	{		hString[0] = NewHandle(63);		iErr = MemError();		if (iErr!=0)			genError ("\pMemory Error");		if (!hString[0])			genError("\pNo Memory");		//MoveHHi(hString[0]);				vRef[0] = NewHandle(2);		iErr = MemError();		if (iErr!=0)			genError ("\pMemory Error");		if (!vRef[0])			genError("\pNo Memory");		//MoveHHi(vRef[0]);						if ((-((*therealResults)[index].vRefNum)) <= maxVRef)  		{			BlockMove(volName[-((*therealResults)[index].vRefNum)],*hString[0],28L);			**vRef[0] = volumes[(-((*therealResults)[index].vRefNum))];		}		else		{			BlockMove(fvolName[-((*therealResults)[index].vRefNum)],*(hString[0]),28L);			**vRef[0] = fvolumes[(-((*therealResults)[index].vRefNum))];		}		AddResource(hString[0],'oVOL',1,"\pVolume Name for list");		iErr = ResError();		if (iErr!=0)			genError("\pCould not add resource");		AddResource(vRef[0],'oREF',1,"\pRefNum for list");		iErr = ResError();		if (iErr!=0)			genError("\pCould not add resource");		finalvRefNum = (SignedByte)(**vRef[0]);		CloseResFile(myRefNum);		//DisposHandle(hString[0]);		//DisposHandle(vRef[0]);		UseResFile(iRefNum);		iErr = FlushVol(0,faveFSpec.vRefNum);			}	else	{		matchedUp = false;			for (z=1;z<=iCnt;z++)		{				hString[0] = Get1Resource('oVOL',z);			if (!hString[0])				genError ("\pCan't get OVOL");			BlockMove	((*(hString[0])),myTempStr,28L);			if (EqualString(fvolName[(-((*therealResults)[index].vRefNum))],myTempStr,false,false)) 			{				vRef[0] = Get1Resource('oREF',z);				if (!vRef[0])					genError ("\pCan't get Oref");				finalvRefNum = (SignedByte)(**vRef[0]);				matchedUp = true;				ReleaseResource(vRef[0]);				iErr = ResError();				if(iErr!=0)					genError ("\pDispos failed");			}			ReleaseResource(hString[0]);			iErr = ResError();			if(iErr!=0)				genError ("\pDispos failed");					}		if (!matchedUp)		{			hString[0] = NewHandle(256);			if (!hString[0])				genError("\pNo Memory");			//MoveHHi(hString[0]);			iErr = MemError();			if (iErr!=0)				genError ("\pMemory Error");						vRef[0] = NewHandle(2);			if (!vRef[0])				genError("\pNo Memory");			//MoveHHi(vRef[0]);			iErr = MemError();			if (iErr!=0)				genError ("\pMemory Error");						if ((-((*therealResults)[index].vRefNum)) <= maxVRef)			{				BlockMove(volName[-((*therealResults)[index].vRefNum)],*hString[0],28L);				**vRef[0] = volumes[(-((*therealResults)[index].vRefNum))];			}			else			{				BlockMove(fvolName[(-((*therealResults)[index].vRefNum))],*hString[0],28L);				**vRef[0] = fvolumes[(-((*therealResults)[index].vRefNum))];			}			AddResource(hString[0],'oVOL',iCnt+1,"\pVolume Name for list");			iErr = ResError();			if (iErr!=0)				genError("\pCould not add resource");			AddResource(vRef[0],'oREF',iCnt+1,"\pVRefNum for list");			iErr = ResError();			if (iErr!=0)				genError("\pCould not add resource");			finalvRefNum = (SignedByte)(**vRef[0]);			//HUnlock (hString[0]);				}		CloseResFile(myRefNum);		UseResFile(iRefNum);		//DisposHandle(hString[0]);		//DisposHandle(vRef[0]);		iErr = FlushVol(0,faveFSpec.vRefNum);	}	/***** write to FSSpecfile *****/	iErr = FSpOpenDF(&faveFSpec,fsCurPerm,&myRefNum);	if (iErr!=0)		genError("\pCould not open new file");		myInOutCounter = 4L; 	totfindlen = 4L;	iErr = FSRead(myRefNum,&myInOutCounter,&theFSSpecLen);			if(iErr !=0)				genError("\pCould not read info from file");					/*myInOutCounter = 70L;	iErr = FSRead(myRefNum,&myInOutCounter,&checkForNull);			if(iErr !=0)				genError("\pCould not read info from file");	if (*checkForNull.name == 0)		theFSSpecLen = 0L;*/			iErr = SetFPos(myRefNum,1,4L+(theFSSpecLen));	howFar = theFSSpecLen / 70L;	myInOutCounter = 70L;		BlockMove (&mySpec,&finalSpec,70L);		finalSpec.vRefNum = finalvRefNum;	iErr = FSWrite(myRefNum,&myInOutCounter,&finalSpec);			if(iErr !=0)				genError("\pCould not write info to file");		iErr = SetFPos(myRefNum,1,0L);	theFSSpecLen +=70L;	myInOutCounter = 4L;	iErr = FSWrite(myRefNum,&myInOutCounter,&theFSSpecLen);			if(iErr !=0)				genError("\pCould not write info to file");	FSClose (myRefNum);				/***** write to FInfo file ***********/								iErr = FSpOpenDF(&faveISpec,fsCurPerm,&myRefNum);	if (iErr!=0)		genError("\pCould not open new file");	iErr = SetFPos(myRefNum,1,((long)howFar * 16L)+4L);	myInOutCounter = 16L; 		iErr = FSWrite(myRefNum,&myInOutCounter,&((*theFInfo)[index]));			if(iErr !=0)				genError("\pCould not write info to file");	howFar ++;	iErr = SetFPos(myRefNum,1,0L);	myInOutCounter = 4;	iErr = FSWrite(myRefNum,&myInOutCounter,&howFar);			if(iErr !=0)				genError("\pCould not write info to file");	FSClose (myRefNum);	FlushVol(nil,faveFSpec.vRefNum);}void makeFaveSpecs(void);void SaveAsFave(void){	OSErr	iErr;	short z;		iErr = FSpDelete(&faveFSpec);	if (iErr != 0)		genError ("\pCan't Delete FSpec file");	iErr = FSpDelete(&faveISpec);	if (iErr != 0)		genError ("\pCan't Delete ISpec file");	makeFaveSpecs();	progressCreate("\pSaving list as Favourite");			for (z=0;z<totfindcounter;z++)	{		AddToFaves(((*therealResults)[z]), z);		if (progressDisp(z*100 / totfindcounter))		{			return;		}	}	progressDispos();	return;}void saveasFaveList(FSSpec mySpec, FSSpec myInfoSpec);void SaveAsTabFave(short whichList){	OSErr	iErr;	short z;	FSSpec faveFile, myFaveInfo;			watchcursor(true);	makefaveFile(whichList,&faveFile,&myFaveInfo);	iErr = FSpDelete(&faveFile);	if (iErr)	{		//genError("\pProblem deleting favefile");	}	iErr = FSpDelete(&myFaveInfo);	if (iErr)	{		//genError("\pProblem deleting favefile info");	}	saveasFaveList(faveFile, myFaveInfo);	watchcursor(false);	return;}void AddToFaveTab(FSSpec	mySpec, short index,short whichList){	OSErr	iErr;	short 	myRefNum;	long	myInOutCounter;	SFTypeList	myTypes;	long	totfindlen;	short z;	long theFInfoCount;	short iRefNum;	Handle hString[499],vRef[499];	long	theFSSpecLen, theFInfoLen;	FSSpec	checkForNull;	long	howFar;	SignedByte finalvRefNum = 0;	FSSpec	finalSpec;	short iCnt;	Boolean	matchedUp;	FInfo fndrInfo;	Str255 myTempStr;		FSSpec faveFile,myFaveInfo;		makefaveFile(whichList,&faveFile,&myFaveInfo);		copyVolsListToFVolsList();	if 	(!FInfolistInMem)	{		FInfoArrayPtr = totfindcounter;		//SetHandleSize(theFInfo,totfindcounter * sizeof(FInfo));		iErr = MemError();		if (iErr != 0)			genError("\pCan't resize theFInfo in save list");						checkHandleSize ((Handle)theFInfo,totfindcounter,sizeof(FInfo));					for (z=0;z<totfindcounter;z++)			{			iErr = FSpGetFInfo(&(*therealResults)[z],(*theFInfo)+z);		}			FInfolistInMem = true;	}	iRefNum = CurResFile();			myRefNum = FSpOpenResFile(&faveFile,fsCurPerm);	if (myRefNum == -1)	{			FSpCreate(&faveFile,'MgAl','SFfl',0);		FSpCreateResFile(&faveFile,'MgAl','SFfl',0);		iErr = ResError();		if (iErr!=0)			genError("\pCould not create resource file");		myRefNum = FSpOpenResFile(&faveFile,fsCurPerm);		if (myRefNum == -1)		{			genError ("\p Problem finding favourite res fork");			return;		}	}			UseResFile(myRefNum);		iErr = ResError();		if (iErr!=0)		genError("\pCould not use resource fork");	iCnt = Count1Resources('oVOL');	if (!iCnt)	/** no oVOLS yet **/	{		hString[0] = NewHandle(63);		iErr = MemError();		if (iErr!=0)			genError ("\pMemory Error");		if (!hString[0])			genError("\pNo Memory");		//MoveHHi(hString[0]);				vRef[0] = NewHandle(2);		iErr = MemError();		if (iErr!=0)			genError ("\pMemory Error");		if (!vRef[0])			genError("\pNo Memory");		//MoveHHi(vRef[0]);						if ((-(mySpec.vRefNum)) <= maxVRef)  		{			BlockMove(volName[-(mySpec.vRefNum)],*hString[0],28L);			**vRef[0] = volumes[(-(mySpec.vRefNum))];		}		else		{			BlockMove(fvolName[-(mySpec.vRefNum)],*(hString[0]),28L);			**vRef[0] = fvolumes[(-(mySpec.vRefNum))];		}		AddResource(hString[0],'oVOL',1,"\pVolume Name for list");		iErr = ResError();		if (iErr!=0)			genError("\pCould not add resource");		AddResource(vRef[0],'oREF',1,"\pRefNum for list");		iErr = ResError();		if (iErr!=0)			genError("\pCould not add resource");		finalvRefNum = (SignedByte)(**vRef[0]);		CloseResFile(myRefNum);		//DisposHandle(hString[0]);		//DisposHandle(vRef[0]);		UseResFile(iRefNum);		iErr = FlushVol(0,faveFile.vRefNum);			}	else	{		matchedUp = false;			for (z=1;z<=iCnt;z++)		{				hString[0] = Get1Resource('oVOL',z);			if (!hString[0])				genError ("\pCan't get OVOL");			BlockMove	((*(hString[0])),myTempStr,28L);			if (EqualString(fvolName[(-(mySpec.vRefNum))],myTempStr,false,false)) 			{				vRef[0] = Get1Resource('oREF',z);				if (!vRef[0])					genError ("\pCan't get Oref");				finalvRefNum =(SignedByte)(**vRef[0]);				matchedUp = true;				ReleaseResource(vRef[0]);				iErr = ResError();				if(iErr!=0)					genError ("\pDispos failed");			}			ReleaseResource(hString[0]);			iErr = ResError();			if(iErr!=0)				genError ("\pDispos failed");					}		if (!matchedUp)		{			hString[0] = NewHandle(256);			if (!hString[0])				genError("\pNo Memory");			//MoveHHi(hString[0]);			iErr = MemError();			if (iErr!=0)				genError ("\pMemory Error");						vRef[0] = NewHandle(2);			if (!vRef[0])				genError("\pNo Memory");			//MoveHHi(vRef[0]);			iErr = MemError();			if (iErr!=0)				genError ("\pMemory Error");						if ((-(mySpec.vRefNum)) <= maxVRef)			{				BlockMove(volName[-(mySpec.vRefNum)],*hString[0],28L);				**vRef[0] = volumes[(-(mySpec.vRefNum))];			}			else			{				BlockMove(fvolName[(-(mySpec.vRefNum))],*hString[0],28L);				**vRef[0] = fvolumes[(-(mySpec.vRefNum))];			}			AddResource(hString[0],'oVOL',iCnt+1,"\pVolume Name for list");			iErr = ResError();			if (iErr!=0)				genError("\pCould not add resource");			AddResource(vRef[0],'oREF',iCnt+1,"\pVRefNum for list");			iErr = ResError();			if (iErr!=0)				genError("\pCould not add resource");			finalvRefNum = (SignedByte)(**vRef[0]);			//HUnlock (hString[0]);				}		CloseResFile(myRefNum);		UseResFile(iRefNum);		//DisposHandle(hString[0]);		//DisposHandle(vRef[0]);		iErr = FlushVol(0,faveFile.vRefNum);	}	/***** write to FSSpecfile *****/	iErr = FSpOpenDF(&faveFile,fsCurPerm,&myRefNum);	if (iErr!=0)		genError("\pCould not open new file");		myInOutCounter = 4L; 	totfindlen = 4L;	iErr = FSRead(myRefNum,&myInOutCounter,&theFSSpecLen);			if(iErr !=0)				genError("\pCould not read info from file");					/*myInOutCounter = 70L;	iErr = FSRead(myRefNum,&myInOutCounter,&checkForNull);			if(iErr !=0)				genError("\pCould not read info from file");	if (*checkForNull.name == 0)		theFSSpecLen = 0L;*/			iErr = SetFPos(myRefNum,1,4L+(theFSSpecLen));	howFar = theFSSpecLen / 70L;	myInOutCounter = 70L;		BlockMove (&mySpec,&finalSpec,70L);		finalSpec.vRefNum = finalvRefNum;	iErr = FSWrite(myRefNum,&myInOutCounter,&finalSpec);			if(iErr !=0)				genError("\pCould not write info to file");		iErr = SetFPos(myRefNum,1,0L);	theFSSpecLen +=70L;	myInOutCounter = 4L;	iErr = FSWrite(myRefNum,&myInOutCounter,&theFSSpecLen);			if(iErr !=0)				genError("\pCould not write info to file");	FSClose (myRefNum);				/***** write to FInfo file ***********/								iErr = FSpOpenDF(&myFaveInfo,fsCurPerm,&myRefNum);	if (iErr!=0)	{						}	iErr = SetFPos(myRefNum,1,((long)howFar * 16L)+4L);	myInOutCounter = 16L; 			FSpGetFInfo(&mySpec,&fndrInfo);		iErr = FSWrite(myRefNum,&myInOutCounter,&(fndrInfo));			if(iErr !=0)				genError("\pCould not write info to file");	howFar ++;	iErr = SetFPos(myRefNum,1,0L);	myInOutCounter = 4;	iErr = FSWrite(myRefNum,&myInOutCounter,&howFar);			if(iErr !=0)				genError("\pCould not write info to file");	FSClose (myRefNum);		FlushVol(nil,faveFile.vRefNum);}void concatStrings(StringPtr sourceA,StringPtr sourceB,Str255 theSeperator);Boolean makefaveFile(short listIndex,FSSpec *theFaveFile, FSSpec *theFaveInfo){	OSErr	iErr;	short myfavesRefNum;	long myfavesDirID;	Str31 theFFName = "\pSampleSearchª FaveSpec";	Str31 theFIName = "\pSampleSearchª FaveInfo";	Str31 theIndexNumber;		NumToString((long)listIndex,theIndexNumber);		concatStrings(theFFName,theIndexNumber,"\p-");	concatStrings(theFIName,theIndexNumber,"\p-");		iErr = FindFolder(-1,'pref',kDontCreateFolder,&myfavesRefNum,&myfavesDirID);	if (iErr!=0)	{		genError("\pCan't find Preferences folder");		return ;	}		iErr = FSMakeFSSpec(myfavesRefNum,myfavesDirID,theFFName,theFaveFile);	if (iErr!=0 && iErr!=-43  )	{		genError("\pCan't make FSSpec for fave file prefs");		return ;	}		iErr = FSMakeFSSpec(myfavesRefNum,myfavesDirID,theFIName,theFaveInfo);	if (iErr!=0 && iErr!=-43  )	{		genError("\pCan't make FSSpec for fave Info prefs");		return ;	}}OSErr copyVolsListToFVolsList(void){	short z;	for (z=0;z<volumearrayptr;z++)	{		fvolumes[z] = volumes[z];		makeStr255 (volName[z], fvolName[z]);	}}