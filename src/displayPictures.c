#include "displayPictures.h"#include "prefs.h"extern newPrefsRec theNewPrefs;#include <Movies.h>#include <ImageCompression.h>#define nothingPressed 0#define keyPressed 1#define buttonPressed 2extern CWindowPtr	myWindow;#include <QuickTimeComponents.h>short isPressed(unsigned short k );#include "JFIF-PICT.h"void playMoviesMain(FSSpec mySpec, float startRatio);/* PICT Files */OSErr displayFileInWindow(FSSpec mySpec){	short refNum;	OSErr iErr;	GrafPtr savePort;	WindowPtr wind;	Rect winRect;	short playType;	Rect picTureRec, useRect;	OpenCPicParams thePCP;	float aspectRatio = 1;		GetPort(&savePort);		playType = nothingPressed;		if (Button())	{		playType = buttonPressed;	}	if (isPressed(0x31))	{		playType = keyPressed;	}			iErr = FSpOpenDF(&mySpec,fsRdPerm,&refNum);	if (iErr)	{		SysBeep(5);		return iErr;	}	iErr = EnterMovies();		iErr = GetPictureFileHeader (refNum, &picTureRec,&thePCP);	if (iErr)	{		FSClose (refNum);		ExitMovies();		return -1;	}		theNewPrefs.displayPictRect = myWindow->portRect;	OffsetRect (&theNewPrefs.displayPictRect,- myWindow->portRect.left, -myWindow->portRect.top);		if (picTureRec.right > 0)	{		aspectRatio = (float)picTureRec.bottom / (float)picTureRec.right;		if (aspectRatio > 1)		{			if (picTureRec.bottom > theNewPrefs.displayPictRect.bottom)			{					float scaler = (float)theNewPrefs.displayPictRect.bottom / (float)picTureRec.bottom;				useRect = theNewPrefs.displayPictRect;				SetRect (&useRect, 0,0,(short)((float)picTureRec.right * scaler),(short)((float)picTureRec.bottom * scaler));			}			else			{				useRect = picTureRec;			}		}		else		{			if (picTureRec.right > theNewPrefs.displayPictRect.right)			{				float scaler = (float)theNewPrefs.displayPictRect.right / (float)picTureRec.right;				useRect = theNewPrefs.displayPictRect;				SetRect (&useRect, 0,0,(short)((float)picTureRec.right * scaler),(short)((float)picTureRec.bottom * scaler));			}			else			{				useRect = picTureRec;			}				}	}			winRect = useRect;	OffsetRect(&winRect,100,100);	wind = NewCWindow(0,&winRect,mySpec.name,1,2,(WindowPtr) -1,true, 0);	if (!wind)	{		FSClose (refNum);		ExitMovies();		return -1;	}		SetPort (wind);		iErr = DrawPictureFile (refNum, &useRect,(ICMProgressProcRecordPtr)0/*-1*/);/*	while (Button())	{		}*/		switch (playType)	{		case nothingPressed:			while (!Button())			{						}		break;				case buttonPressed:			while (Button())			{						}		break;			case keyPressed:			while (isPressed(0x31))			{						}		break;	}		DisposeWindow(wind);	FSClose (refNum);	ExitMovies();	SetPort (savePort);}OSErr displayJPEGileInWindow(FSSpec mySpec){	short refNum;	OSErr iErr;	GrafPtr savePort;	WindowPtr wind;	Rect winRect;	short playType;	Rect picTureRec, useRect;	OpenCPicParams thePCP;	float aspectRatio = 1;		GetPort(&savePort);		playType = nothingPressed;		if (Button())	{		playType = buttonPressed;	}	if (isPressed(0x31))	{		playType = keyPressed;	}			iErr = EnterMovies();	iErr = getJFIFRect (mySpec,&picTureRec);	if (iErr)	{		ExitMovies();		return -1;	}		theNewPrefs.displayPictRect = myWindow->portRect;	OffsetRect (&theNewPrefs.displayPictRect,- myWindow->portRect.left, -myWindow->portRect.top);		if (picTureRec.right > 0)	{		aspectRatio = (float)picTureRec.bottom / (float)picTureRec.right;		if (aspectRatio > 1)		{			if (picTureRec.bottom > theNewPrefs.displayPictRect.bottom)			{					float scaler = (float)theNewPrefs.displayPictRect.bottom / (float)picTureRec.bottom;				useRect = theNewPrefs.displayPictRect;				SetRect (&useRect, 0,0,(short)((float)picTureRec.right * scaler),(short)((float)picTureRec.bottom * scaler));			}			else			{				useRect = picTureRec;			}		}		else		{			if (picTureRec.right > theNewPrefs.displayPictRect.right)			{				float scaler = (float)theNewPrefs.displayPictRect.right / (float)picTureRec.right;				useRect = theNewPrefs.displayPictRect;				SetRect (&useRect, 0,0,(short)((float)picTureRec.right * scaler),(short)((float)picTureRec.bottom * scaler));			}			else			{				useRect = picTureRec;			}				}	}			winRect = useRect;	OffsetRect(&winRect,100,100);	wind = NewCWindow(0,&winRect,mySpec.name,1,2,(WindowPtr) -1,true, 0);	if (!wind)	{		ExitMovies();		return -1;	}		SetPort (wind);		displayJFIFFileInWindow(mySpec, useRect, (CGrafPort *)wind);//	iErr = DrawPictureFile (refNum, &useRect,(ICMProgressProcRecordPtr)0/*-1*/);/*	while (Button())	{		}*/		switch (playType)	{		case nothingPressed:			while (!Button())			{						}		break;				case buttonPressed:			while (Button())			{						}		break;			case keyPressed:			while (isPressed(0x31))			{						}		break;	}		DisposeWindow(wind);		ExitMovies();	SetPort (savePort);}Boolean importMovieToDisplayPict(FSSpec mySpec){	OSErr err;	StandardFileReply reply;	SFReply putFile;	FSSpec newFile;	Str255 newName, theComment;	Point where = {100,100};	Component c;	ComponentDescription cd;	FInfo fndrInfo;	OSErr iErr;		BlockMove (&mySpec,&reply.sfFile,70L);	newName[++newName[0]] = '!';		BlockMove (&mySpec,&newFile,70L);	newFile.parID = 2;	newFile.vRefNum = -1;	FSpGetFInfo(&mySpec,&fndrInfo);	//reply.sfType = 'AIFF';	reply.sfType = fndrInfo.fdType;	cd.componentType = MovieImportType;	cd.componentSubType = reply.sfType;	cd.componentManufacturer = 0;	cd.componentFlags = canMovieImportFiles;	cd.componentFlagsMask = canMovieImportFiles;		c = FindNextComponent(nil, &cd);	if (!c) return false;						// too weird. no import component exists		GetComponentInfo(c, &cd, nil, nil, nil);	if (cd.componentFlags & hasMovieImportUserInterface)  /* make this work as a batch process */	{		MovieImportComponent importer;		Boolean canceled = false;		importer = OpenComponent(c);		err = MovieImportDoUserDialog(importer, &reply.sfFile, nil, &canceled);		if (err || canceled) {			CloseComponent(importer);			return false;		}		err = ConvertFileToMovieFile(&reply.sfFile, &newFile, 'TVOD', -1, nil,			0, importer,0 /*(MovieProgressProcPtr)-1*/, 0);		CloseComponent(importer);			} 	else 	{		// no import user interface option, so let the toolbox open the component		err = ConvertFileToMovieFile(&reply.sfFile, &newFile, 'TVOD', -1, nil,			0,0/* (ComponentInstanceRecord *)&c*//*nil*/, 0/*NewMovieProgressProc(-1)*/, 0);	}	if (err) 	{		SysBeep(1);		DeleteMovieFile(&newFile);		return true;	}	else	/* flatten it */	{		short resId  =1000, zerores=0;		Movie theMovie = 0;		short resRef;		OpenMovieFile(&newFile, &resRef, fsWrPerm);		NewMovieFromFile(&theMovie, resRef, &zerores, nil,			 	0, nil);		CloseMovieFile(resRef);		if (!theMovie) return false;			}	playMoviesMain(newFile,0);	iErr = FSpDelete (&newFile);	return true;}