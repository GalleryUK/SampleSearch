#include "SampleSearch.h"extern FSSpec theConvertDestLoc;extern FSSpec theNewFileLeft, theNewFileRight;short GetWAVInfo (FSSpec mySpec,long  *theSRate, short *theWordSize,long *theDuration, Boolean *isStereo, long *length);long findCOMM(short localRefNum, OSType	theType);Boolean pcConv(Ptr theBuff, long inOutCount);Boolean pcConv8(Ptr theBuff,long inOutCount);Boolean writeSDIIResources(FSSpec theSpec,long theRate,Boolean stereo,short theWordSize);Boolean GetFSComment(FSSpec mySpec, Str255 theComment);Boolean SetFSComment (FSSpec mySpec, StringPtr theComment);Boolean WAVStereoToSDIISplit(FSSpec mySpec);Boolean WAVStereoToSDIISplit(FSSpec mySpec){	Fixed theRate;	short numBits,numChans;	Boolean stereo;	short sourceRef, destRefL, destRefR, rfRefNum, iRefNum,theWordSize;	OSErr	iErr;	long filePos,bytesTilEnd,theTote;	long inOutCount;	long audiosize,AOffset;	FSSpec theNewFileL, theNewFileR;	Str255 theComment;	Ptr mySndH, leftBuffer, rightBuffer;	StringHandle h1,h2,h3;	Str255 theStringa,theStringb,theStringc,theStringd;	long thefirstbit, thesecondbit;	FInfo	fndrInfo;	Boolean changeSign;	long theSRate;	long theDuration;	Boolean isStereo;	long extraA,extraB;	Handle theExtraHandleA,theExtraHandleB;	Boolean notDone = true;	long bytes,bytesRead = 0,z;	float theFloat;    short thePercent;    OSType myWAVType;    	if (!GetWAVInfo (mySpec,&theSRate, &theWordSize,&theDuration, &isStereo, &bytes))	{		return false;	}		if (!isStereo)	{		return false;	}	iErr = FSpOpenDF(&mySpec,fsCurPerm,&sourceRef);	if (iErr!=0)	{		genError ("\pCan't open file");		return false;	}		filePos = findCOMM(sourceRef,'data');	if (!filePos)	{		genError ("\pCan't find data chunk");		iErr = FSClose(sourceRef);		return false;	}	iErr = SetFPos(sourceRef,1,filePos + 8L);		mySndH = NewPtr(131072L);					/** buffer a **/	if (!mySndH)	{		genError("\pNot enough memory, increase partition size");		FSClose(sourceRef);		return false;	}		leftBuffer= NewPtr(65536L);					/** buffer b **/	if (!leftBuffer)	{		genError("\pNot enough memory, increase partition size");		FSClose(sourceRef);		return false;	}			rightBuffer= NewPtr(65536L);					/** buffer c **/	if (!rightBuffer)	{		genError("\pNot enough memory, increase partition size");		FSClose(sourceRef);		return false;	}		stereo = isStereo;		theRate = (unsigned long)theSRate;			/* strip .WAV if present */		BlockMove(mySpec.name + (*mySpec.name) -3L,&myWAVType,4L);	if (myWAVType == '.WAV')	{		*mySpec.name -= 4;	}			BlockMove (&mySpec,&theNewFileL,70L);	BlockMove (&mySpec,&theNewFileR,70L);	theNewFileL.parID = theConvertDestLoc.parID;	theNewFileL.vRefNum = theConvertDestLoc.vRefNum;		theNewFileR.parID = theConvertDestLoc.parID;	theNewFileR.vRefNum = theConvertDestLoc.vRefNum;			concatStrings(theNewFileL.name,"\pL","\p-");	concatStrings(theNewFileR.name,"\pR","\p-");			BlockMove (&theNewFileL,&theNewFileLeft,70L);		BlockMove (&theNewFileR,&theNewFileRight,70L);		 ;	iErr = FSpCreate(&theNewFileL,'Sd2a','Sd2f',0);	if (iErr != 0)	{		if (iErr == dupFNErr)		{			if (YesNo ("\pFile Exists, overwrite ?"))			{				FSpDelete (&theNewFileL);				iErr = FSpCreate(&theNewFileL,'Sd2a','Sd2f',0);			}			else			{				return false;			}		}	}	FSpCreateResFile(&theNewFileL,'Sd2a','Sd2f',0);	if (iErr != 0)	{		genError("\pCan't create new res file");		FSClose(sourceRef);		DisposPtr(mySndH);	DisposPtr(leftBuffer);	DisposPtr(rightBuffer);		return false;	}	iErr = FSpOpenDF(&theNewFileL,fsWrPerm,&destRefL);	if (iErr != 0)	{		genError("\pCan't create new file");		FSClose(sourceRef);		DisposPtr(mySndH);	DisposPtr(leftBuffer);	DisposPtr(rightBuffer);		return false;	}				iErr = FSpCreate(&theNewFileR,'Sd2a','Sd2f',0);	if (iErr != 0)	{		if (iErr == dupFNErr)		{			if (YesNo ("\pFile Exists, overwrite ?"))			{				FSpDelete (&theNewFileR);				iErr = FSpCreate(&theNewFileR,'Sd2a','Sd2f',0);			}			else			{				return false;			}		}	}		FSpCreateResFile(&theNewFileR,'Sd2a','Sd2f',0);	if (iErr != 0)	{		genError("\pCan't create new res file");		FSClose(sourceRef);	FSClose(destRefL);		DisposPtr(mySndH);	DisposPtr(leftBuffer);	DisposPtr(rightBuffer);		return false;	}	iErr = FSpOpenDF(&theNewFileR,fsWrPerm,&destRefR);	if (iErr != 0)	{		genError("\pCan't create new file");		FSClose(sourceRef);	FSClose(destRefL);		DisposPtr(mySndH);	DisposPtr(leftBuffer);	DisposPtr(rightBuffer);		return false;	}		progressCreate("\pConverting File");		while (notDone)	{		inOutCount = 131072L;		if (!bytes)		{			bytes = 1L;		}				theFloat = ((float)bytesRead / (float)bytes) * 100;    	thePercent = theFloat;		if (progressDisp(thePercent))		{			FSClose(sourceRef);			FSClose(destRefL);			FSClose(destRefR);			DisposPtr(mySndH);			DisposPtr(leftBuffer);			DisposPtr(rightBuffer);			return false;		}			iErr = FSRead(sourceRef,&inOutCount,mySndH);		if (iErr != 0 && iErr != eofErr)		{			progressDispos();			genError("\pCan't read source file");			FSClose(sourceRef);			FSClose(destRefL);			FSClose(destRefR);			DisposPtr(mySndH);			DisposPtr(leftBuffer);			DisposPtr(rightBuffer);			return false;		}		if (iErr == eofErr)		{			notDone = false;		}				if (theWordSize == 16)		{			pcConv(mySndH,inOutCount);			for (z=0;z<inOutCount;z+=4L)			{				*(short *)(leftBuffer + (z >> 1)) = *(short *)(mySndH + z);				*(short *)(rightBuffer + (z >> 1)) = *(short *)(mySndH + z + 2);						}		}			if (theWordSize == 8)		{			pcConv8(mySndH,inOutCount);			for (z=0;z<inOutCount;z+=2L)			{				*(Byte *)(leftBuffer + (z >> 1)) = *(Byte *)(mySndH + z);				*(Byte *)(rightBuffer + (z >> 1)) = *(Byte *)(mySndH + z + 1);						}		}					bytesRead += inOutCount;				inOutCount = inOutCount >>1;				iErr = FSWrite(destRefL,&inOutCount,leftBuffer);		if (iErr != 0)		{						progressDispos();			genError("\pCan't write dest file");			FSClose(sourceRef);			FSClose(destRefL);			FSClose(destRefR);			DisposPtr(mySndH);			DisposPtr(leftBuffer);			DisposPtr(rightBuffer);			return false;		}				iErr = FSWrite(destRefR,&inOutCount,rightBuffer);		if (iErr != 0)		{						progressDispos();			genError("\pCan't write dest file");			FSClose(sourceRef);			FSClose(destRefL);			FSClose(destRefR);			DisposPtr(mySndH);			DisposPtr(leftBuffer);			DisposPtr(rightBuffer);			return false;		}	}		progressDispos();	FSClose(sourceRef);	FSClose(destRefL);	FSClose(destRefR);	DisposPtr(mySndH);	DisposPtr(leftBuffer);	DisposPtr(rightBuffer);		writeSDIIResources(theNewFileL,theSRate,false,theWordSize >> 3);	writeSDIIResources(theNewFileR,theSRate,false,theWordSize >> 3);		addFileToList(theNewFileL);	addFileToList(theNewFileR);		GetFSComment(mySpec, theComment);	SetFSComment (theNewFileL, theComment);	SetFSComment (theNewFileR, theComment);	return true;}