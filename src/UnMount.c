#include "SampleSearch.h"#include "Globals.h"void concatStrings(StringPtr sourceA,StringPtr sourceB,Str255 theSeperator);extern FSSpec theApplSpec;Boolean MemToFSSpec(FSSpec mySpec, Boolean justSelected, Boolean askForSpec, Boolean toFaves, Boolean toClipboard);void resolveOVols(void);void checkList(void);void doTheSlashAnalysis(StringPtr theTempVol);Boolean UnMount(StringPtr tempstrB);Boolean UnMount(StringPtr tempstrB){	short itemHit;				/** for dialog enquiry **/	DialogPtr	myDlg;			/** for dialog enquiry **/	Handle	iHndl;				/** for dialog enquiry **/	Rect	iRect;				/** for dialog enquiry **/	short	iType;				/** for dialog enquiry **/	short z;	MenuHandle	hRsrc;	short catIndexNo;	HFileParam	pb;	Str255 theNameStr;	OSErr	iErr;	long	theCount= 4L;	long	theFInfoCount;	short iRefNum;	StringHandle	hString[499];	Str255	theName, theTempVol;	FSSpec	theBackUpSpec;	Handle vRef[499];	FSSpec	theDriveSpec;	EventRecord theEvent;	short menuVRefs[99];	short menuitem = 1;		FInfoArrayPtr = 0;		iErr = FSMakeFSSpec(theApplSpec.vRefNum,theApplSpec.parID,"\pSFTempFile",&theBackUpSpec);	if (iErr != -43)		iErr = FSpDelete(&theBackUpSpec);	MemToFSSpec(theBackUpSpec, false, false, false,false);				snapFileLen = 0L;	gogetvolref();	hRsrc = GetMenu(1010);	hRsrc = (MenuHandle)GetResource('MENU',1010);	for (z=1;z<=volumearrayptr;z++)			/*** set up loop to go through all registered drives **/	{		makeStr255 (volName[z], theTempVol);		doTheSlashAnalysis(theTempVol);		if (*theTempVol)		{			menuVRefs[menuitem] = volumes[z];			menuitem++;			AppendMenu(hRsrc,theTempVol);			iErr = ResError();		}	}	ParamText(0,0,tempstrB,0);	myDlg = GetNewDialog(6543,0L,(WindowPtr)-1);		SetPort (myDlg);	color.red = 56797;	color.green = 56797;	color.blue = 56797;	RGBBackColor(&color);	GetDItem(myDlg,3,&iType,&iHndl,&iRect);	SetDItem(myDlg,3,iType,(Handle)NewUserItemProc(MyItemProc),&iRect);	ShowWindow(myDlg);	while (itemHit != 1 && itemHit != 2)	{		ModalDialog(xAlertFilter,&itemHit);		GetDItem(myDlg,5,&iType,&iHndl,&iRect);  			/** get handle etc of popup **/		iCtlValue = GetCtlValue((ControlHandle)iHndl);  		switch (itemHit)		{			case 1:			break;						case 2:			break;						case 6:				pb.ioCompletion = 0;				pb.ioNamePtr = nil;				pb.ioVRefNum = menuVRefs[iCtlValue]; //volumes[iCtlValue];				if (isPressed (0x3A))				{					iErr = PBUnmountVol((union ParamBlockRec *)&pb);					if (iErr != 0)					{						genError("\pCan't unmount that volume because it is in use");						break;					}				}				pb.ioCompletion = 0;				pb.ioNamePtr = nil;				pb.ioVRefNum = menuVRefs[iCtlValue]; //volumes[iCtlValue];					iErr = PBEject((union ParamBlockRec *)&pb);					if (iErr != 0)				{					genError("\pCan't eject that volume because it is in use");					break;				}						gogetvolref();				for (z=1;z<=28;z++)				{					DelMenuItem(hRsrc,1);				}				menuitem = 1;				for (z=1;z<=volumearrayptr;z++)			/*** set up loop to go through all registered drives **/				{					makeStr255 (volName[z], theTempVol);					doTheSlashAnalysis(theTempVol);					if (*theTempVol)					{						menuVRefs[menuitem] = volumes[z];						menuitem++;						AppendMenu(hRsrc,theTempVol);						iErr = ResError();					}				}				checkList();			GetDItem(myDlg,5,&iType,&iHndl,&iRect);  			/** get handle etc of popup **/			SetCtlValue((ControlHandle)iHndl,1);  			break;						case 7:				for (z=0;z<= 10;z++)				{					GetNextEvent(everyEvent,&theEvent);				}								for (z=0;z<=28;z++)				{					DelMenuItem(hRsrc,1);				}				checkList();				gogetvolref();				menuitem = 1;				for (z=1;z<=volumearrayptr;z++)			/*** set up loop to go through all registered drives **/				{					makeStr255 (volName[z], theTempVol);					if(EqualString(tempstrB,theTempVol,true,true)) 					{						short iItemCnt;												doTheSlashAnalysis(theTempVol);						if (*theTempVol)						{							menuVRefs[menuitem] = volumes[z];							menuitem++;							AppendMenu(hRsrc,theTempVol);							iErr = ResError();							iItemCnt = CountMItems(hRsrc);							GetDItem(myDlg,5,&iType,&iHndl,&iRect);  								SetCtlValue((ControlHandle)iHndl,iItemCnt);							UpdtControl(myDlg,myDlg->visRgn);						}											}					else					{						doTheSlashAnalysis(theTempVol);						if (*theTempVol)						{							menuVRefs[menuitem] = volumes[z];							menuitem++;							AppendMenu(hRsrc,theTempVol);							iErr = ResError();						}					}				}			break;		}	}	DisposDialog(myDlg);		openFSList(theBackUpSpec);		//checkList();	gogetvolref();	resolveOVols();					iErr = FSpDelete(&theBackUpSpec);	if (iErr != 0)		genError ("\pCan't Delete temp file");		if (itemHit == 2)		return false;			return true;}