#include "SampleSearch.h"#include "Globals.h"extern FSSpec theApplSpec;extern long AliasesDirID;//extern short applVRefNum;#define SFSaveDisk 	0x00000214#define CurDirStore 0x00000398void windowUpdate(void);void divertLoadSelect(void);void divertLoadSelect(void){StandardFileReply reply;FInfo fndrInfo;Handle myhString;SFTypeList mytypeList;OSErr	iErr;short theVolRef;	BlockMove (&AliasesDirID,(Ptr)CurDirStore,4L);	theVolRef = -(theApplSpec.vRefNum);	BlockMove (&theVolRef,(Ptr)SFSaveDisk,2L);	mytypeList[0] = 'APPL';mytypeList[1] = 'adrp';	StandardGetFile(0,2,mytypeList,&reply);	 if (reply.sfGood)	 {	 	BlockMove(&(reply.sfFile),&divertSpec,70L);		setDivertAppSpec(reply.sfFile);		iErr = FSpGetFInfo(&(reply.sfFile),&fndrInfo);	  	myhString = (Handle)GetString(998);		BlockMove(&(fndrInfo.fdCreator),(*myhString)+1,4L);		ChangedResource(myhString);		WriteResource(myhString);		divertDocCreator = fndrInfo.fdCreator;		}}void divertLoadChoose(void);void divertLoadChoose(void){StandardFileReply reply;FInfo fndrInfo;Handle myhString;SFTypeList mytypeList;OSErr	iErr;CInfoPBRec	cipbr;				/* local pb */HFileInfo	*fpb = (HFileInfo *)&cipbr;	/* to pointers */DirInfo	*dpb = (DirInfo *) &cipbr;short	rc, idx;Str255	dirFullName;long myDrDir;long dirID;MenuHandle hMenu;AliasHandle alias;FSSpec mySpec[16];short fRefNum;Boolean wasChanged;long lMnuAndItm;Point localPt;short iResult;Str255 theTempStr;FSSpec	theCurrentOne;short iRefNum;/*FInfo	currentType;*/short theOne = 1;		theCurrentOne =	getDivertAppSpec();		/*iErr = FSpGetFInfo(&theCurrentOne,&currentType);*/				fpb->ioVRefNum = theApplSpec.vRefNum;		/* default volume */		dirID = AliasesDirID;		fpb->ioNamePtr = zfilename;	/* buffer to receive name */		hMenu = NewMenu(6543,"\pDivert Load Aliases");				if (!hMenu)			genError("\pCould not make menu 6543");					//InsertMenu(hMenu,-1);		for( idx=1; TRUE; idx++) 		{	/* indexing loop */			fpb->ioDirID = dirID;		/* must set on each loop */			myDrDir = dirID;			fpb->ioFDirIndex = idx;					rc = PBGetCatInfo( &cipbr, FALSE );			if (rc) 				break;	/* exit when no more entries */				if (!(fpb->ioFlAttrib & 16)) 			{			/** i.e it is a file **/				if (fpb->ioFlFndrInfo.fdType == 'APPL') 				{					iErr = FSMakeFSSpec(fpb->ioVRefNum,myDrDir,fpb->ioNamePtr,&mySpec[idx]);									}				if (fpb->ioFlFndrInfo.fdType == 'adrp' )				{					iErr = FSMakeFSSpec(fpb->ioVRefNum,myDrDir,fpb->ioNamePtr,&mySpec[idx]);					if (iErr != 0)					{						genError ("\pCan't Make FSSpec");						break;					}					iRefNum = CurResFile();					fRefNum = FSpOpenResFile(&mySpec[idx],fsCurPerm);					if (fRefNum == -1)					{											genError ("\pCan't open alias");						break;					}										alias = (AliasHandle)GetResource('alis',0);					iErr = ResolveAlias(nil,alias,&mySpec[idx],&wasChanged);					UseResFile(iRefNum);				}								AppendMenu(hMenu,mySpec[idx].name);				if (iErr)					DisableItem(hMenu,idx);				if(EqualString(theCurrentOne.name,mySpec[idx].name,true,true)) 					{						/*CheckItem(hMenu,idx,true);*/						theOne = idx;					}								}			}			InsertMenu(hMenu,-1);			GetMouse(&localPt);			LocalToGlobal(&localPt);			lMnuAndItm = PopUpMenuSelect(hMenu,localPt.v,localPt.h,theOne);			iResult = LoWord(lMnuAndItm);			if (!iResult)				return;									 /* make an FSSpec of it */	 {	 	BlockMove(&(mySpec[iResult]),&divertSpec,70L);		setDivertAppSpec(mySpec[iResult]);		iErr = FSpGetFInfo(&(mySpec[iResult]),&fndrInfo);	  	BlockMove(&(fndrInfo.fdCreator),theTempStr+1,4L);	  	*theTempStr = 4;	  	myhString = (Handle)GetString(998);	  	if (!myhString)	  	{	  		myhString = (Handle)NewString(theTempStr);	  		AddResource(myhString,'STR ',998,"\pDivertApp");	  		myhString = (Handle)GetString(998);	  	}		BlockMove(&(fndrInfo.fdCreator),(*myhString)+1,4L);		**myhString = 4;		ChangedResource(myhString);		WriteResource(myhString);		divertDocCreator = fndrInfo.fdCreator;		}	windowUpdate();	return;}