//Boolean checkoutGearbox(void);#include "SampleSearch.h"#include "Globals.h"#include "prefs.h"#define numDefinedBITTargets 4OSType theBITTargets [numDefinedBITTargets] = {'PTul', 'EMAG', 'stCA', 'Sd2a'};Str31 theBITTargetsNames[numDefinedBITTargets] = {"\pPro Tools¨","\pLogic Audio", "\pCubase Audio","\pSound Designer II"};Boolean theBitTargetSplits[numDefinedBITTargets] = {1,1,1,0};OSErr sendODOCEvent(FSSpec theTransferredFile, OSType destProcess);OSErr sendPTRegion(FSSpec theTransferredFile);extern newPrefsRec theNewPrefs;extern OSType  myeventFileType;    //	'APPL'extern OSType  myeventCreatorType;   //'WILD'extern unsigned long myEventID;	//kAEOpenDocumentsextern unsigned long myEventClass;  //kCoreEventClass						OSErr chooseTargetAppOther(OSType * Sig, StringPtr AppName, short * splitFiles);OSErr FindAProcess(OSType typeToFind, OSType creatorToFind,			ProcessSerialNumberPtr processSN);void makeStr255(Str255 theString, StringPtr thePtr);OSErr PFindAProcess(OSType typeToFind, OSType creatorToFind,			ProcessSerialNumberPtr processSN);OSErr sendRegionsToPT(FSSpec theTransferredFile);OSErr GetFileGray(FSSpec *myFSSpec);void PTExcludeList(void);void setBringIntoProToolsDefaults (void);			void setBringIntoProToolsDefaults (void){	RGBColor color;	Cell theCell;	short theindex;	OSErr	iErr;	short itemHit;				/** for dialog enquiry **/	DialogPtr	myDlg;			/** for dialog enquiry **/	Handle	iHndl;				/** for dialog enquiry **/	Rect	iRect;				/** for dialog enquiry **/	short	iType,z;				/** for dialog enquiry **/	MenuHandle hMenu;	NumVersion version;	MenuHandle theExclMenu, targetMenu;	Str255 strtemp,strtemp1;	short ds,iCtlVal;	Boolean GBPresent = 1;//checkoutGearbox();		theExclMenu = GetMenu(700);	if (!theExclMenu)	{		genError ("\pProblem loading menu 700");		return;	}		targetMenu = GetMenu(4506);	if (!targetMenu)	{		genError ("\pProblem loading menu 4506");		return;	}	for (z=0;z<theNewPrefs.numberOfPTExclusions;z++)	{		//AppendMenu(theExclMenu,theNewPrefs.PTExcludedDrive[z]);		InsMenuItem(theExclMenu,theNewPrefs.PTExcludedDrive[z],0);	}		myDlg = GetNewDialog(1560,0L,(WindowPtr)-1);	SetPort (myDlg);		GetDItem(myDlg,5,&iType,&iHndl,&iRect);	SetCtlValue((ControlHandle)(ControlHandle)iHndl,!theNewPrefs.theBITPTPrefs.forceCopy);	GetDItem(myDlg,4,&iType,&iHndl,&iRect);	SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.forceCopy);		GetDItem(myDlg,7,&iType,&iHndl,&iRect);	if (theNewPrefs.theBITPTPrefs.destFolderValid)	{			}	else	{		makeStr255("\pUndefined",theNewPrefs.theBITPTPrefs.destFolder.name);	}	SetCTitle((ControlHandle)(ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.destFolder.name);		GetDItem(myDlg,9,&iType,&iHndl,&iRect);	SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.changeRate);		GetDItem(myDlg,8,&iType,&iHndl,&iRect);	SetCtlValue((ControlHandle)iHndl,!theNewPrefs.theBITPTPrefs.sampleRate48K + 1);		if (!GBPresent)	{		GetDItem(myDlg,9,&iType,&iHndl,&iRect);		HiliteControl((ControlHandle)(ControlHandle)iHndl,255);		theNewPrefs.theBITPTPrefs.changeRate = false;	}	else	{		GetDItem(myDlg,9,&iType,&iHndl,&iRect);		HiliteControl((ControlHandle)iHndl,0);	}		GetDItem(myDlg,16,&iType,&iHndl,&iRect);	SetCtlValue((ControlHandle)iHndl,6);	makeStr255 ("\pOtherÉ  : ",strtemp);	BlockMove (&theNewPrefs.theBITPTPrefs.targetApp,strtemp + 11,4L);	*strtemp = 14;	SetItem(targetMenu,6,strtemp);	for (ds=0;ds<numDefinedBITTargets;ds++)	{			if (theNewPrefs.theBITPTPrefs.targetApp == theBITTargets[ds])		{			SetCtlValue((ControlHandle)iHndl,ds+1);		}	}			GetDItem(myDlg,19,&iType,&iHndl,&iRect);		SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.sessionResolution);	//	HiliteControl((ControlHandle)iHndl,255); /* this isnt working yet !!!! */	ShowWindow(myDlg);	itemHit = -1;	while (itemHit != 1 && itemHit != 2)	{		ModalDialog(xAlertFilter,&itemHit);		switch (itemHit)		{			case 4:				GetDItem(myDlg,4,&iType,&iHndl,&iRect);				SetCtlValue((ControlHandle)iHndl,true);				GetDItem(myDlg,5,&iType,&iHndl,&iRect);				SetCtlValue((ControlHandle)iHndl,false);				theNewPrefs.theBITPTPrefs.forceCopy = true;			break;					case 5:				GetDItem(myDlg,5,&iType,&iHndl,&iRect);				SetCtlValue((ControlHandle)iHndl,true);				GetDItem(myDlg,4,&iType,&iHndl,&iRect);				SetCtlValue((ControlHandle)iHndl,false);				theNewPrefs.theBITPTPrefs.forceCopy = false;			break;					case 7:				GetDItem(myDlg,7,&iType,&iHndl,&iRect);				iErr  =  GetFileGray(&theNewPrefs.theBITPTPrefs.destFolder);				if (iErr)				{					makeStr255("\pUndefined",theNewPrefs.theBITPTPrefs.destFolder.name);					theNewPrefs.theBITPTPrefs.destFolderValid = false;						SetCTitle((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.destFolder.name);						theNewPrefs.theBITPTPrefs.destFolder.vRefNum = -1;					theNewPrefs.theBITPTPrefs.destFolder.parID = 2;				}				else				{					theNewPrefs.theBITPTPrefs.destFolderValid = true;					SetCTitle((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.destFolder.name);					}			break;						case 9:				GetDItem(myDlg,9,&iType,&iHndl,&iRect);				SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.changeRate = !(GetCtlValue((ControlHandle)(ControlHandle)iHndl)));				if (!GBPresent)				{					GetDItem(myDlg,9,&iType,&iHndl,&iRect);					SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.changeRate = false);				}				version = SndSoundManagerVersion();				if ( ! ( version.majorRev >= 3 && version.minorAndBugRev >= 0x02 ) )				{						genError("\pSound Manager is older than 3.2 - Gearbox cannot operate");					GetDItem(myDlg,9,&iType,&iHndl,&iRect);					SetCtlValue((ControlHandle)iHndl,theNewPrefs.theBITPTPrefs.changeRate = false);				}			break;						case 8:				GetDItem(myDlg,8,&iType,&iHndl,&iRect);				theNewPrefs.theBITPTPrefs.sampleRate48K = !(GetCtlValue((ControlHandle)iHndl) - 1);			break;						case 19:				GetDItem(myDlg,19,&iType,&iHndl,&iRect);				theNewPrefs.theBITPTPrefs.sessionResolution = GetCtlValue((ControlHandle)iHndl);			break;			case 15: /* pop up menu */				GetDItem(myDlg,15,&iType,&iHndl,&iRect);								if(GetCtlValue((ControlHandle)iHndl) == theNewPrefs.numberOfPTExclusions+1)				{					PTExcludeList();										SetResAttrs((Handle)theExclMenu,0);					ReleaseResource((Handle)theExclMenu);									theExclMenu = GetMenu(700);					if (!theExclMenu)					{						genError ("\pProblem loading menu 700");						return;					}										for (z=0;z<theNewPrefs.numberOfPTExclusions;z++)					{						//AppendMenu(theExclMenu,theNewPrefs.PTExcludedDrive[z]);						InsMenuItem(theExclMenu,theNewPrefs.PTExcludedDrive[z],0);					}						/*rebuild the menu */				}			break;			case 16: /* target pop up */				GetDItem(myDlg,16,&iType,&iHndl,&iRect);				switch (iCtlVal = GetCtlValue((ControlHandle)iHndl))				{						case 1:case 2:case 3:case 4:						theNewPrefs.theBITPTPrefs.targetApp = theBITTargets[iCtlVal-1];						makeStr255 ("\pOtherÉ  : ",strtemp);						BlockMove (&theNewPrefs.theBITPTPrefs.targetApp,strtemp + 11,4L);						*strtemp = 14;											theNewPrefs.theBITPTPrefs.splitFiles = theBitTargetSplits[iCtlVal-1];						//SetItem(targetMenu,6,strtemp);					break;					case 6:						iErr = chooseTargetAppOther(&theNewPrefs.theBITPTPrefs.targetApp,theNewPrefs.theBITPTPrefs.targetAppName, &theNewPrefs.theBITPTPrefs.splitFiles);					//	makeStr255 (theNewPrefs.theBITPTPrefs.targetAppName, strtemp1);					//	concatStrings (strtemp1,"\p","\p ");						*strtemp1 = 0;						BlockMove (&theNewPrefs.theBITPTPrefs.targetApp ,strtemp1 + 1,4L);						*strtemp1 = 4;						makeStr255 ("\pOtherÉ  : ",strtemp);						concatStrings (strtemp,strtemp1,"\p");						SetItem(targetMenu,6,strtemp);					break;				}			break;					}	}	ReleaseResource((Handle)theExclMenu);	DisposDialog(myDlg);}OSErr sendPTAEvent(FSSpec theTransferredFile, Boolean sendRegions);OSErr sendPTAEvent(FSSpec theTransferredFile, Boolean sendRegions){	AppleEvent	aeEvent;	/* the event to create*/	AEDesc	myAddressDesc;	/* descriptors for the */	AEDesc	aeDirDesc[1];	AEDesc	listElem;	AEDesc	fileList;		/*our list*/	FSSpec	dirSpec;	EventRecord theEvent;	short z;	AliasHandle	fileAlias[1];		/* alias of the file itself*/	AliasHandle	theAliasH[1];	ProcessSerialNumber process;	/* the finder's psn*/	OSErr		myErr;				/* duh*/	FSSpec	mySpec;	FInfo	fndrInfo;	Boolean	CreatorChanged;	OSType	preserveCreator;	//Boolean	isSample;	CInfoPBRec	pb;	StandardFileReply	reply;	short temprefNum;	OSErr	iErr;	short switchCount;	char	myChar;	long	theParID;	short itemHit;				/** for dialog enquiry **/	DialogPtr	myDlg;			/** for dialog enquiry **/	Handle	iHndl;				/** for dialog enquiry **/	Handle  myHand;	Rect	iRect;				/** for dialog enquiry **/	Rect	myRect;	short	iType;				/** for dialog enquiry **/	short p;	if (sendRegions)	{		return sendRegionsToPT(theTransferredFile);	}/*	myeventFileType = 'FNDR';	myeventCreatorType = 'MACS';	myEventID	= kAEOpenDocuments;	myEventClass = kCoreEventClass;    this send events to the finder */		myeventFileType = 'APPL';	myeventCreatorType = theNewPrefs.theBITPTPrefs.targetApp; //'PTul';  /* fill in the correct creator type here */ 	myEventID = kAEOpenDocuments;	myEventClass = kCoreEventClass;	if(PFindAProcess(myeventFileType,myeventCreatorType,&process))	{			//SysBeep(5);			/*genError ("\pProTools is not running");*/			return;	}		myErr = AECreateDesc(typeProcessSerialNumber,(Ptr) &process,sizeof(process), &myAddressDesc);	if(myErr)		{		genError("\pAppleEvent error");		return;	}	myErr = AECreateAppleEvent (myEventClass, myEventID,&myAddressDesc, kAutoGenerateReturnID, kAnyTransactionID,&aeEvent);	if(myErr)	{		genError("\pAppleEvent error");		return;	}	if(myErr=AECreateList(nil,0,false,&fileList))	{		genError("\pAppleEvent error");		return;	}			NewAlias(nil,&theTransferredFile,&fileAlias[0]);			theAliasH[0] = fileAlias[0];				HLock((Handle)theAliasH[0]);			AECreateDesc(typeAlias, (Ptr) *theAliasH[0], GetHandleSize((Handle) theAliasH[0]), &aeDirDesc[0]);		HUnlock((Handle)theAliasH[0]);				myErr = AEPutDesc (&fileList, 1+0, &aeDirDesc[0]);			if(myErr = AEPutParamDesc(&aeEvent,keyDirectObject,&fileList))			return myErr;		myErr = AESend(&aeEvent, nil,kAENoReply+kAEAlwaysInteract+kAECanSwitchLayer,kAEHighPriority, kAEDefaultTimeout, nil, nil);	AEDisposeDesc(&aeEvent);			for (z=0;z<30;z++)	{		WaitNextEvent(everyEvent,&theEvent,0,0);	}}OSErr sendODOCEvent(FSSpec theTransferredFile, OSType destProcess){	AppleEvent	aeEvent;	/* the event to create*/	AEDesc	myAddressDesc;	/* descriptors for the */	AEDesc	aeDirDesc[1];	AEDesc	listElem;	AEDesc	fileList;		/*our list*/	FSSpec	dirSpec;	EventRecord theEvent;	short z;	AliasHandle	fileAlias[1];		/* alias of the file itself*/	AliasHandle	theAliasH[1];	ProcessSerialNumber process;	/* the finder's psn*/	OSErr		myErr;				/* duh*/	FSSpec	mySpec;	FInfo	fndrInfo;	Boolean	CreatorChanged;	OSType	preserveCreator;	//Boolean	isSample;	CInfoPBRec	pb;	StandardFileReply	reply;	short temprefNum;	OSErr	iErr;	short switchCount;	char	myChar;	long	theParID;	short itemHit;				/** for dialog enquiry **/	DialogPtr	myDlg;			/** for dialog enquiry **/	Handle	iHndl;				/** for dialog enquiry **/	Handle  myHand;	Rect	iRect;				/** for dialog enquiry **/	Rect	myRect;	short	iType;				/** for dialog enquiry **/	short p;	myeventFileType = 'APPL';	myeventCreatorType = destProcess; //'PTul';  /* fill in the correct creator type here */ 	myEventID = kAEOpenDocuments;	myEventClass = kCoreEventClass;	if(PFindAProcess(myeventFileType,myeventCreatorType,&process))	{			//SysBeep(5);			/*genError ("\pProTools is not running");*/			return;	}		myErr = AECreateDesc(typeProcessSerialNumber,(Ptr) &process,sizeof(process), &myAddressDesc);	if(myErr)		{		genError("\pAppleEvent error");		return;	}	myErr = AECreateAppleEvent (myEventClass, myEventID,&myAddressDesc, kAutoGenerateReturnID, kAnyTransactionID,&aeEvent);	if(myErr)	{		genError("\pAppleEvent error");		return;	}	if(myErr=AECreateList(nil,0,false,&fileList))	{		genError("\pAppleEvent error");		return;	}			NewAlias(nil,&theTransferredFile,&fileAlias[0]);			theAliasH[0] = fileAlias[0];				HLock((Handle)theAliasH[0]);			AECreateDesc(typeAlias, (Ptr) *theAliasH[0], GetHandleSize((Handle) theAliasH[0]), &aeDirDesc[0]);		HUnlock((Handle)theAliasH[0]);				myErr = AEPutDesc (&fileList, 1+0, &aeDirDesc[0]);			if(myErr = AEPutParamDesc(&aeEvent,keyDirectObject,&fileList))			return myErr;		myErr = AESend(&aeEvent, nil,kAENoReply+kAEAlwaysInteract+kAECanSwitchLayer,kAEHighPriority, kAEDefaultTimeout, nil, nil);	AEDisposeDesc(&aeEvent);			for (z=0;z<30;z++)	{		WaitNextEvent(everyEvent,&theEvent,0,0);	}}Boolean makeRegionsListFromFile(FSSpec mySpec);typedef struct miniRegionRec {long	StartFrame;long	StopFrame;Str31 regionName;} miniRegionRec, *miniRegionRecPtr;extern miniRegionRec * theRegionPointsPtr;#define theRegionPoints theRegionPointsPtrextern short theNumberOfRegions;void ProToolsSpotRegionWithRate (FSSpec theFile,Str255 regionName, short trkNum, unsigned long startFrame, unsigned long endFrame, unsigned long theFrameCount,short theSessFrameRate);OSErr sendRegionsToPT(FSSpec theTransferredFile){	short x;			if (makeRegionsListFromFile(theTransferredFile))	{		writeLogS((unsigned char *)"\pStarting export of all regions for file :");		writeLogS(theTransferredFile.name);		for (x=0;x<theNumberOfRegions;x++)		{			ProToolsSpotRegionWithRate (theTransferredFile,theRegionPoints[x].regionName, 0, theRegionPoints[x].StartFrame, theRegionPoints[x].StopFrame,0,44100);		}		DisposPtr((Ptr)theRegionPointsPtr);		return noErr;	}	else	{		return sendPTAEvent(theTransferredFile, false);	}}